<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manual Punch | OM Enterprise</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<style>
body{
  font-family:Roboto,Arial,sans-serif;
  background:#111;color:#fff;
  display:flex;justify-content:center;align-items:center;
  height:100vh;margin:0;
}
.container{
  background:#1b1b1b;padding:30px;border-radius:12px;
  width:350px;text-align:center;
}
h1{color:#00d4ff;margin-bottom:20px;}
select,input{width:100%;padding:10px;margin:10px 0;border-radius:6px;border:none;font-size:14px;}
button{width:48%;padding:12px;margin-top:10px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;transition:0.3s;}
button.in{background:#00d4ff;color:#000;}
button.out{background:#ff6f61;color:#fff;}
button:hover{opacity:0.9;}
#status{margin-top:15px;font-size:14px;color:#ffeb3b;}
</style>
</head>
<body>

<div class="container">
  <h1>Manual Punch</h1>

  <select id="empSelect"></select>
  <input type="date" id="punchDate">

  <div class="time-box">
    <button class="in" onclick="punchIn()">Punch IN (Auto Time)</button>
    <button class="out" onclick="punchOut()">Punch OUT (Auto Time)</button>
  </div>

  <div id="status"></div>
</div>

<script>
/* ================= EMPLOYEES ================= */
const employees = [
  {id:"101", name:"Ishwarbhai Patel"},
  {id:"104", name:"Shailesh Panchal"},
  {id:"105", name:"Nitin Panchal"}
];
const empSelect = document.getElementById("empSelect");
employees.forEach(e=>{
  empSelect.innerHTML += `<option value="${e.id}|${e.name}">${e.id} - ${e.name}</option>`;
});

/* ================= INDEXEDDB ================= */
let db;
const request = indexedDB.open("OM_ATTENDANCE_DB",1);

request.onupgradeneeded = e=>{
  db = e.target.result;
  if(!db.objectStoreNames.contains("attendance")){
    db.createObjectStore("attendance",{keyPath:"key"});
  }
};

request.onsuccess = e=>{ db = e.target.result; };

/* ================= HELPERS ================= */
function getDate(){
  const d = document.getElementById('punchDate').value;
  if(!d) { alert("Select date"); return null; }
  return d;
}

// Format time in 12-hour AM/PM format
function formatTime(date){
  let h = date.getHours();
  let m = date.getMinutes();
  const mer = h >= 12 ? "PM" : "AM";
  h = h % 12;
  if(h === 0) h = 12;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")} ${mer}`;
}

// Convert AM/PM to 24-hour for calculations
function timeTo24(timeStr){
  let [hm, mer] = timeStr.split(" ");
  let [h,m] = hm.split(":").map(Number);
  if(mer==="PM" && h!==12) h+=12;
  if(mer==="AM" && h===12) h=0;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:00`;
}

/* ================= PUNCH IN ================= */
function punchIn(){
  const emp = empSelect.value;
  const date = getDate();
  if(!emp || !date) return alert("Select employee and date");

  const [id,name] = emp.split("|");
  const key = id+date;

  const now = new Date();
  const inTime = formatTime(now);

  const tx = db.transaction("attendance","readwrite");
  const store = tx.objectStore("attendance");
  const req = store.get(key);

  req.onsuccess = ()=>{
    if(req.result && req.result.inTime) return alert("Already punched IN");
    const record = {key,id,name,date,inTime,outTime:"-",workHours:"0"};
    store.put(record);
    document.getElementById('status').innerText = `Punch IN saved for ${name} at ${inTime}`;
  };
}

/* ================= PUNCH OUT ================= */
function punchOut(){
  const emp = empSelect.value;
  const date = getDate();
  if(!emp || !date) return alert("Select employee and date");

  const [id,name] = emp.split("|");
  const key = id+date;

  const now = new Date();
  const outTime = formatTime(now); // AM/PM

  const tx = db.transaction("attendance","readwrite");
  const store = tx.objectStore("attendance");
  const req = store.get(key);

  req.onsuccess = ()=>{
    const r = req.result;
    if(!r || r.outTime!=="-") return alert("Cannot punch OUT or already punched");

    r.outTime = outTime;

    // Calculate work hours (24-hour conversion) minus 1 hour recess
    const in24 = timeTo24(r.inTime);
    const out24 = timeTo24(outTime);

    const [inH,inM] = in24.split(":").map(Number);
    const [outH,outM] = out24.split(":").map(Number);
    let diff = (outH + outM/60) - (inH + inM/60) - 1; // minus recess
    r.workHours = diff>0?diff.toFixed(2):"0.00";

    store.put(r);
    document.getElementById('status').innerText = `Punch OUT saved for ${name} at ${outTime}`;
  };
}
</script>

</body>
</html>
